function updatesiteinfobtn(){return putSiteInfo(),!1}function getSiteInfo(){$.ajax({type:"GET",url:rootURL+"/siteinfo/"+getLanguage(),dataType:"json",success:function(e){console.log("getSiteInfo success: "+e.siteinfo.site_title),siteinfo=e.siteinfo,renderSiteInfo(siteinfo),renderList()}})}function putSiteInfo(){console.log("putSiteInfo"),$.ajax({type:"PUT",contentType:"application/json",url:rootURL+"/siteinfo",dataType:"json",data:updateSiteInfoToJSON(),success:function(){fade("#savedfade"),getSiteInfo(),getAllSiteNames()},error:function(e,t){alert("putSiteInfo error: "+t)}})}function renderSiteInfo(e){$("title").text(e.site_title+" - bearbeiten"),$("#head-sitelink").html("<b>"+e.site_title+' <i class="icon-angle-right"></i></b>'),$("#sitetitle").val(e.site_title),$("#siteheadline").val(e.site_headline),$("#sitetheme").val(e.site_theme),$("#levelstarget").val(e.site_levels),$("#levels .btn").removeClass("btn-active"),button()}function updateSiteInfoToJSON(){return data=JSON.stringify({apikey:apikey,title:$("#sitetitle").val(),theme:$("#sitetheme").val(),headline:$("#siteheadline").val(),levels:$("#levelstarget").val(),language:getLanguage()}),data}function openlanguagesbtn(){return $(".editlanguagespopup").show(),$("#newlanguage").focus(),!1}function langsel(){var e=$(".lang-sel").val();null!==$.cookie("LANGUAGE")&&$.removeCookie("LANGUAGE"),$.cookie("LANGUAGE",e),console.log("newLang: "+e),$("#changedlangfade").html(getLanguage()),fade("#changedlangfade"),"block"!==$("#preferences").css("display")&&showRight(""),getAllSiteNames(),getSiteInfo(),currentEntry=""}function submitnewlang(){var e=$("input#newlanguage").val();""!==e&&postLanguage(e)}function deletelangbutton(){return confirm("[OK] drücken um die Sprache "+$(this).data("lang")+" zu löschen.")?(deleteLanguage($(this).data("lang")),!1):void 0}function getLanguage(){return $.cookie("LANGUAGE")}function getLanguages(){console.log("getLanguages"),$.ajax({type:"GET",url:rootURL+"siteinfo?apikey="+apikey,dataType:"json",success:function(e){languages=e.siteinfo.languages,renderLanguages(".lang-sel")}})}function postLanguage(e){console.log("postLanguage"),$.ajax({type:"POST",contentType:"application/json",url:rootURL+"/siteinfo",dataType:"json",data:langToJSON(e),success:function(){console.log("postLang success"),fade("#savedfade"),getLanguages(),$("#newlanguage").val(""),getAllSiteNames()},error:function(e){e.responseText.indexOf("UNIQUE")>-1&&alert("Diese Sprache existiert bereits."),console.log("postLang error: "+e.responseText),getLanguages(),$("#newlanguage").val("")}})}function deleteLanguage(e){$.ajax({type:"DELETE",url:rootURL+"/siteinfo/"+e,data:JSON.stringify({apikey:apikey}),success:function(){console.log("deleteLangSuccess: "+e),fade("#deletedfade"),getLanguages(),$.cookie("LANGUAGE")==e&&($.removeCookie("LANGUAGE"),$.cookie("LANGUAGE",languages[0])),getSiteInfo(),getAllSiteNames()},error:function(){alert("deleteUser error: "+$("#user").val())}})}function renderLanguages(e){$(e).html($("<option disabled>").html("Sprache/Language")),$(".language-list").html(""),$.each(languages,function(t,n){$(e).append($("<option></option>").val(n).html(n).attr("selected",n==siteinfo.site_language)),$(".language-list").append($("<li>").addClass("push").append(n).append(siteinfo.default_language!==n?$('<a href="#">').addClass("deletelangbutton btn redbtn push-right").attr("data-lang",n).text("Löschen"):""))}),$(".deletelangbutton").unbind().click(deletelangbutton)}function langToJSON(e){return data=JSON.stringify({apikey:apikey,language:e}),data}function linkhello(){return showRight("hello"),$(".menu-id").hide(),!1}function closepopup(){$(".popupoverflow").hide()}function linknew(){return showRight("edit"),newEntry(),!1}function addChild(){console.log("addChild");var e=$(this).data("level"),t=$(this).data("pos");newLevel=e+1,newPos=t+1,linknew()}function prefbtn(){return console.log("einstellungen"),$("#hello").hide(),$("#edit").hide(),$("#preferences").toggle(),$("#preferences").is(":visible")&&$(".openlanguagesbtn").focus(),!1}function menulink(){console.log("menulink"),showRight("edit"),getEntry($(this).data("identity"))}function newEntry(){currentEntry={},renderEntry(currentEntry)}function getAllSiteNames(){console.log("getAllSiteNames"),$.ajax({type:"GET",url:rootURL+"/entries/"+getLanguage()+"?apikey="+apikey,dataType:"json",success:function(e){console.log("getAllSiteNames success"),renderList(e),sitelist=e}})}function renderList(e){console.log("renderList");var t=null===e.entries?[]:e.entries instanceof Array?e.entries:[e.entries];$("#menu_list li").remove();var n="",i="1"===$("#levelstarget").val()&&isadmin;isadmin&&(n='<span class="dragger push-right"><i class="icon-drag"></i></span></li>'),$.each(t,function(e,t){if(visible_class=t.visible?[]:" ishidden",visible_icon=t.visible?[]:'<i class="icon-eye-shut eyeshut"></i>',visible_popup=t.visible?[]:'<span class="tooltip"><span>Wird auf der Webseite derzeit nicht angezeigt.</span></span>',levels="",i&&t.level>=1)for(var a=0;a<t.level;a++)levels+='<span class="levels"></span>';var s="";i&&t.level<1&&"Menuepunkt"===t.template&&(s='<a href="#" class="addChild-Button" data-level="'+t.level+'" data-identity="'+t.id+'"data-pos="'+t.pos+'"><span class="tooltip"><span>Unterseite erstellen</span></span>+</a>'),$("#menu_list").append('<li id="'+t.id+'" class="row-split'+visible_class+'"><a href="#" class="menulink row-split" data-identity="'+t.id+'">'+levels+"<b>"+t.title+'</b><i class="icon-edit edit"></i> '+visible_icon+visible_popup+"</a>"+s+n)}),isadmin||$("a.menulink").css("width","246px"),i&&$(".addChild-Button").closest("li").find(".menulink").addClass("smallMenulink"),$("#menu_list li a.menulink").unbind().click(menulink),$(".addChild-Button").unbind().click(addChild)}function newOrderToJSON(e){return data=JSON.stringify({apikey:apikey,neworder:e,language:getLanguage()}),data}function adduserbtn(){return renderUser(),!1}function isadmincheckbox(){var e=$(".isadmincheckbox").prop("checked");return e?$(".userpopup-sitelist-container").hide():$(".userpopup-sitelist-container").show(),!1}function editusrbtn(){return getUserPrefs($(this).data("identity")),!1}function deleteusrbtn(){return confirm("[OK] drücken um den User zu löschen.")?($(".userpopup").hide(),deleteUser($(this).data("identity")),!1):void 0}function getUsers(e){$.ajax({type:"GET",url:rootURL+"/users?apikey="+apikey,dataType:"json",success:function(t){console.log("getUsers success"),e(t)}})}function putUser(e,t){$.ajax({type:"PUT",contentType:"application/json",url:rootURL+"/users/"+e,dataType:"json",data:userToJSON(),success:function(e){console.log("putUser success"),fade("#savedfade"),updateAdminSites(e.id,t),getUsers(renderUserList),$("#newuseremail").val(""),$(".userpopup").hide()},error:function(e,t){alert("putAdmin error: "+t)}})}function postUser(e){$.ajax({type:"POST",contentType:"application/json",url:rootURL+"/users",dataType:"json",data:userToJSON(),success:function(t){console.log("postUser success"),fade("#savedfade"),updateAdminSites(t.id,e),getUsers(renderUserList),$("#newuseremail").val(""),$(".userpopup").hide()},error:function(e){e.responseText.indexOf("UNIQUE")>-1&&alert("Dieser Nutzer existiert bereits."),console.log("postUser error: "+e.responseText),getUsers(renderUserList),$("#newuseremail").val("")}})}function getUserPrefs(e){console.log("getUserPrefs"),$.ajax({type:"GET",url:rootURL+"/users/"+e+"?apikey="+apikey,dataType:"json",success:function(e){getAllSiteNames(),renderUser(e)},error:function(e,t){alert("getUser error: "+t)}})}function deleteUser(e){$.ajax({type:"DELETE",url:rootURL+"/users/"+e,data:JSON.stringify({apikey:apikey}),success:function(){console.log("deleteUsersuccess: "+e),fade("#deletedfade"),getUsers(renderUserList)},error:function(){alert("deleteUser error: "+$("#user").val())}})}function updateAdminSites(e,t){"undefined"==typeof t&&(t=adminsitesToJSON()),console.log("addAdminsites"),$.ajax({type:"POST",contentType:"application/json",url:rootURL+"/users/"+e+"/sites/"+getLanguage(),dataType:"json",data:t,success:function(){console.log("addAdminsites success")},error:function(e,t){console.log("addAdminsites error: "+t)}})}function renderUserList(e){console.log("renderUserList");var t=null===e.users?[]:e.users instanceof Array?e.users:[e.users];$(".admin-list li").remove(),$(".user-list li").remove(),$.each(t,function(e,t){"1"===t.admin||"on"===t.admin?(ac+=1,$(".admin-list").append($("<li>").addClass("push").append(t.user_email).append(t.user_email===current_admin?$("<span>").text("angemeldet").addClass("push-right").css({"font-weight":"bold",color:"green"}):$('<a href="#">').addClass("editusrbutton btn push-right").attr("data-identity",t.id).text("Bearbeiten")))):($(".user-list").html(""),$(".user-list").append($("<li>").addClass("push").append(t.user_email).append($('<a href="#">').addClass("editusrbutton btn push-right").attr("data-identity",t.id).text("Bearbeiten"))))}),$(".user-list li").is("li")||$(".user-list").append($("<li>").append("Keine")),$(".editusrbutton").unbind().click(editusrbtn)}function renderUser(e){$(".userpopup").show(),$(".invalidmail").text(""),renderTemplateList("#usertemplate");var t=null===sitelist.entries?[]:sitelist.entries instanceof Array?sitelist.entries:[sitelist.entries];if($(".userpopup-sitelist li").remove(),$.each(t,function(e,t){$(".userpopup-sitelist").append($("<li>").append($("<input>").addClass("userpopupcheckbox").attr("type","checkbox").attr("data-id",t.id).attr("id",t.id+"check").after($("<label>").addClass("bold popuplistlabel").text(t.title).attr("for",t.id+"check"))))}),"undefined"==typeof e)console.log("renderNewUser"),$(".userpopuptitle").text("Neuen Benutzer anlegen"),$("#useremail").val("").focus(),$("#submitsiteprefs").removeAttr("data-id"),$("#deleteusrbutton").hide();else{console.log("renderUser"),$(".userpopuptitle").text(e.user_email+" - Eigenschaften"),$("#submitsiteprefs").attr("data-id",e.id),$("#useremail").val(e.user_email).focus(),"1"===e.admin&&($(".isadmincheckbox").prop("checked","checked"),isadmincheckbox());var n=null===e.sites?[]:e.sites instanceof Array?e.sites:[e.sites];$.each(n,function(e,t){$(".userpopup-sitelist input.userpopupcheckbox[data-id="+t+"]").attr("checked","checked")}),"1"===e.admin?$("#deleteusrbutton").hide():($("#deleteusrbutton").show(),$("#deleteusrbutton").attr("data-identity",e.id),$("#deleteusrbutton").unbind().click(deleteusrbtn))}}function userToJSON(){return data=JSON.stringify({apikey:apikey,admin:$(".isadmincheckbox").is(":checked"),email:$("#useremail").val()}),data}function adminsitesToJSON(){var e=[];return $(".userpopupcheckbox:checked").each(function(){e.push($(this).attr("data-id"))}),data=JSON.stringify({apikey:apikey,sites:e}),data}function submitsitebutton(){return""!==$("#title").val()?(""===$("#entryId").val()?addEntry():updateEntry(),!1):void 0}function deleteentrybtn(){return confirm("[OK] drücken um den Eintrag zu löschen.")?($(".editpopup").hide(),$("#edit").hide(),deleteEntry($(this).data("id")),!1):void 0}function levelup(){var e=parseFloat($("#levelcount").text());return e++,updateLevel(e),!1}function leveldown(){var e=parseFloat($("#levelcount").text());return e>=1&&e--,updateLevel(e),!1}function editsitebutton(){return $(".site-prefs").toggle(),$(".site-prefs").is(":visible")&&$(".showsiteaminpopup").focus(),!1}function showsiteaminpopup(){return getUsers(renderSiteadminsPopup),!1}function submitsiteadmins(){return""!==$("#entryId").val()?(console.log("call updateSiteadmins()"),updateSiteadmins($("#entryId").val()),closepopup(),$(".showsiteaminpopup").focus(),fade("#savedfade")):(console.log("just close the popup"),closepopup(),$(".showsiteaminpopup").focus()),!1}function getTemplates(){console.log("getTemplates"),$.ajax({type:"GET",url:rootURL+"availableTemplates?apikey="+apikey,dataType:"json",success:function(e){templates=e}})}function getEntry(e){console.log("getEntry"),$.ajax({type:"GET",url:rootURL+"/entries/"+getLanguage()+"/"+e+"?apikey="+apikey,dataType:"json",success:function(e){$("#deletebutton").show(),currentEntry=e,renderEntry(currentEntry)},error:function(e,t){alert("getEntry error: "+t)}})}function addEntry(){console.log("addEntry");var e=siteadminsToJSON();$.ajax({type:"POST",contentType:"application/json",url:rootURL+"/entries/"+getLanguage(),dataType:"json",data:newEntryToJSON(),success:function(t){fade("#savedfade"),console.log("INSERTED: "+t.inserted.id),getEntry(t.inserted.id),updateSiteadmins(t.inserted.id,e),getAllSiteNames(),newPos=null,newLevel=0},error:function(e,t){newPos=null,newLevel=0,alert("addEntry error: "+t)}})}function updateEntry(){console.log("updateEntry");var e=$("#entryId").val();$.ajax({type:"PUT",contentType:"application/json",url:rootURL+"/entries/"+getLanguage()+"/"+e,dataType:"json",data:updateEntryToJSON(),success:function(){fade("#savedfade"),updateSiteadmins(e),getEntry(e),getAllSiteNames()},error:function(e,t){alert("updateEntry error: "+t)}})}function deleteEntry(e){console.log("deleteEntry"),$.ajax({type:"DELETE",url:rootURL+"/entries/"+getLanguage()+"/"+e,data:JSON.stringify({apikey:apikey}),success:function(){fade("#deletedfade"),getAllSiteNames()},error:function(){alert("deleteEntry error")}})}function updateLevel(e){console.log("updateLevel"),console.log(e),$.ajax({type:"PUT",contentType:"application/json",url:rootURL+"/entries/"+getLanguage()+"/"+$("#entryId").val()+"/level",dataType:"json",data:updateLevelToJSON(e),success:function(){getEntry($("#entryId").val()),getAllSiteNames()},error:function(e,t){alert("updateEntry error: "+t)}})}function updateSiteadmins(e,t){"undefined"==typeof t&&(t=siteadminsToJSON()),console.log("addSiteadmins"),$.ajax({type:"POST",contentType:"application/json",url:rootURL+"/entries/"+getLanguage()+"/"+e+"/siteadmins",dataType:"json",data:t,success:function(){console.log("addSiteadmins success")},error:function(e,t){console.log("addSiteadmins error: "+t)}})}function renderEntry(e){var t,n=e.entry;console.log(n),t=n&&"string"!==n.template?n.template:"ws-edit-default",console.log("foo"),$("#edit_main").load("templates/"+t,function(){console.log("bar"),$(".submitsitebutton").unbind().click(submitsitebutton),$(".editsitebutton").unbind().click(editsitebutton),$("#leveldown").unbind().click(leveldown),$("#levelup").unbind().click(levelup),$(".showsiteaminpopup").click(showsiteaminpopup),$(".site-prefs").hide(),renderTemplateList("#templateSelector"),$(".editsitebutton").show(),$(".ckeditor").ckeditor();var n=e.entry;n&&"string"!==n.id?(date=new Date(1e3*n.mtime).toUTCString(),$("#editlegend").html('<i class="icon-edit"></i> Seite bearbeiten <span id="time">(letzte &Auml;nderung: '+date+"</span>"),$("#entryId").val(n.id),$("#title").val(n.title).focus(),$("#siteprefsbtn").attr("data-id",n.id),$("textarea.contentarea").val(n.content),$("#levelcount").text(n.level),"1"===$("#levelstarget").val()?($("#leveloption").show(),$("#leveloption .btn-group").show()):$("#leveloption").hide(),"1"===n.visible?$("#visiblecheckbox").attr("checked","checked"):$("#visiblecheckbox").removeAttr("checked"),$("#deleteentrybutton").attr("data-id",n.id),$("#deleteentrybutton").unbind().click(deleteentrybtn)):(console.log("newSite"),$(".deleteoption").hide(),$("#editlegend").html('<i class="icon-pencil"></i> Neue Seite'),$("#entryId").val(""),$("#title").val("").focus(),$("#visiblecheckbox").attr("checked","checked"),$("textarea.contentarea").val(""),"1"===$("#levelstarget").val()?($("#leveloption").show(),$("#leveloption .btn-group").hide()):$("#leveloption").hide()),window[t]()})}function renderSiteadminsPopup(e){console.log("renderSiteadminsPopup"),$(".editsiteadminspopup").show();var t=null===e.users?[]:e.users instanceof Array?e.users:[e.users];if($(".editsiteadminspopup-userlist li").remove(),$.each(t,function(e,t){$(".editsiteadminspopup-userlist").append($("<li>").append($("<input>").addClass("editsiteadminspopupcheckbox").attr("type","checkbox").attr("data-id",t.id).attr("data-mail",t.user_email).attr("id",t.user_email)).append($("<label>").addClass("bold").text(t.user_email).attr("for",t.user_email)))}),$(".editsiteadminspopupcheckbox:first").focus(),"undefined"==typeof currentEntry.entry)$('.editsiteadminspopupcheckbox[data-mail="'+current_admin+'"]').attr("checked","checked");else{var n=null===currentEntry.entry.siteadmins?[]:currentEntry.entry.siteadmins instanceof Array?currentEntry.entry.siteadmins:[currentEntry.entry.siteadmins];$.each(n,function(e,t){$(".editsiteadminspopup-userlist input.editsiteadminspopupcheckbox[data-id="+t+"]").attr("checked","checked")})}$("#submitsiteadmins").unbind().click(submitsiteadmins)}function renderTemplateList(e){console.log("renderTemplateList"),$(e).html(""),$.each(templates,function(t,n){var i=n;"ws-edit-default"===i&&(i="default"),"ws-"!==i.substring(0,3)&&$(e).append($("<option></option>").val(n).html(i).attr("selected",function(){if("undefined"!=typeof currentEntry&&"undefined"!=typeof currentEntry.entry&&"undefined"!=typeof currentEntry.entry.template){if(n===currentEntry.entry.template)return"selected"}else if("default"===i)return"selected"}))})}function newEntryToJSON(){var e=$("#templateSelector").val();return"default"===e&&(e="ws-edit-default"),data=JSON.stringify({apikey:apikey,title:$("#title").val(),content:$("textarea.contentarea").val(),visible:$("#visiblecheckbox").is(":checked"),pos:newPos,level:newLevel,parentpos:null===newPos?null:newPos-1,language:getLanguage(),template:e}),data}function updateEntryToJSON(){var e=$("#templateSelector").val();return"default"===e&&(e="ws-edit-default"),data=JSON.stringify({apikey:apikey,id:$("#entryId").val(),title:$("#title").val(),content:$("textarea.contentarea").val(),visible:$("#visiblecheckbox").is(":checked"),language:getLanguage(),template:e}),data}function updateLevelToJSON(e){return data=JSON.stringify({apikey:apikey,value:e}),data}function siteadminsToJSON(){var e=[];return $(".editsiteadminspopupcheckbox:checked").each(function(){e.push($(this).attr("data-id"))}),data=JSON.stringify({apikey:apikey,siteadmins:e}),data}init=function(){console.log("init"),$("html").click(function(){$(".site-prefs").hide()}),$("#logo").click(linkhello),$("#linknew").click(linknew),$("#prefbtn").click(prefbtn),$(".adduserbtn").click(adduserbtn),$(".isadmincheckbox").change(isadmincheckbox),$(".openlanguagesbtn").click(openlanguagesbtn),$(".lang-sel").change(langsel),$("#submitlangbtn").click(submitnewlang),$(".closepopup").click(closepopup),$(".popupoverflow").click(closepopup),$(".popup, .site-prefs").click(function(e){e.stopPropagation()}),$("#updatesiteinfobtn").click(updatesiteinfobtn)},onLoad=function(){console.log("onLoad"),$("#loader").hide(),linkhello(),getSiteInfo(),getAllSiteNames(),getUsers(renderUserList),dragMenu(),getLanguages(),getTemplates(),$("#page").fadeToggle(800),$(".head").fadeToggle(800),$("#deletebutton").hide(),$("#leveloption").hide(),$("#menu_list").sortable("refresh")};var rootURL="../api/index.php",langSelected=getLanguage(),siteinfo,languages,sitelist;dragMenu=function(){console.log("dragMenu");var e=$("#menu_list");e.sortable({placeholder:"dragger_placeholder",handle:".dragger",opacity:.7,delay:150,appendTo:document.body,update:function(){console.log("update");var e=$("#menu_list").sortable("toArray");console.log(e),$.ajax({type:"PUT",contentType:"application/json",url:rootURL+"/entries/"+getLanguage()+"/neworder",dataType:"json",data:newOrderToJSON(e),error:function(e,t,n){console.log("newOrder error: "+t+n)}})}}),e.disableSelection()};var user={},ac=0;usermailvalidate=function(e){return e.indexOf(".")>2&&e.indexOf("@")>0?("undefined"!=typeof $("#submitsiteprefs").data("id")?putUser($("#submitsiteprefs").data("id"),adminsitesToJSON()):postUser(adminsitesToJSON()),$(".invalidmail").text(""),!0):($(".invalidmail").text("Keine gültige Emailadresse"),void console.log("Email nicht gueltig bei useremail"))};var currentEntry,templates,newPos=null,newLevel=0;fade=function(e){$(e).delay(10).fadeToggle("slow","linear").delay(1500).fadeToggle("slow","linear")},showRight=function(e){$(".rightpanel").each(function(){$(this).hide()}),e.match("^#")?$(e).show():$("#"+e).show()},$("img").error(function(){$(this).attr("src","static/img/bgbig.png")}),$(document).keyup(function(e){if($(".userpopup").is(":visible"))(27===e.keyCode||27===e.which)&&($(".closepopup").click(),$(".adduserbtn").focus());else if($(".editlanguagespopup").is(":visible"))(27===e.keyCode||27===e.which)&&($(".closepopup").click(),$(".openlanguagesbtn").focus());else if($("#preferences").is(":visible"))(27===e.keyCode||27===e.which)&&($("#preferences").toggle(),$("#prefbtn").focus());else if($(".editsiteadminspopup").is(":visible"))(27===e.keyCode||27===e.which)&&($(".closepopup").click(),$(".showsiteaminpopup").focus());else if($(".site-prefs").is(":visible"))(27===e.keyCode||27===e.which)&&($(".site-prefs").hide(),$(".editsitebutton").focus());else if(27===e.keyCode||e.which)return}),$(document).ready(init());